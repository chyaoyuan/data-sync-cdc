import json
import time

import requests
from urllib.parse import quote

from loguru import logger


def get_candidate_info_list(project_id: str, headers):
    result = {"projectId": project_id}
    candidate_list = []
    index = 0
    while True:
        time.sleep(1)
        url = "https://www.linkedin.com/talent/search/api/talentRecruiterSearchHits"

        data="decoration=%28entityUrn%2ClinkedInMemberProfileUrn~%28entityUrn%2Canonymized%2CreferenceUrn%2CmemberPreferences%28companySizeRange%28minSize%2CmaxSize%29%2CemploymentTypes%2CinterestedCandidateIntroductionStatement%2Clocations%2CjobSeekingUrgencyLevel%2CgeoLocations*~%28standardGeoStyleName%29%2CopenToNewOpportunities%2Ctitles%2CproxyPhoneNumberAvailability%29%2CfirstName%2ClastName%2Cheadline%2Clocation%28displayName%29%2CprofilePicture%2CvectorProfilePicture%2CnumConnections%2Chighlights%2CnetworkDistance%2Cskills*%28skillAssessmentVerified%2CskillAssessmentVerifiedAt%2CskillName%2Cskill%29%2CcanSendInMail%2Cunlinked%2Ceducations*%28school~%28entityUrn%2Cname%29%2CorganizationUrn~%28entityUrn%2Cname%29%2CschoolName%2CdegreeName%2CstartDateOn%2CendDateOn%29%2CworkExperience*%28company~%28entityUrn%2Cname%29%2CcompanyName%2Ctitle%2CstartDateOn%2CendDateOn%29%2CprivacySettings%28allowConnectionsBrowse%2CshowPremiumSubscriberIcon%29%2CviewerCompanyFollowing%28followingViewerCompany%2CstartedAt%29%2CcontactInfo%2CindustryName%2CpublicProfileUrl%29%2ChiringProjectRecruitingProfile~%28entityUrn%2Ctags*%2ChiringContext%2Ccandidate%2ChiddenCandidate%2CcurrentHiringProjectCandidate%28entityUrn%2Ccreated%28time%29%2CaddedToPipeline%28time%2Cactor~%28profile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%29%2ClastModified%2ChiringProject~%28entityUrn%2ChiringProjectMetadata%28hiringPipelineEnabled%2Cstate%29%29%2CcandidateHiringState%2CsourcingChannel~%28entityUrn%2CchannelType%29%2CsourcingChannelType%29%2CstartFollowingCompanyAt%2ClastActivity~%28activityType%2Cperformed%28time%2Cactor~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%2CperformedByViewer%2ChiringActivityData%29%2CcandidateMessageThreads*%28candidate%2CentityUrn%2ClastInboxSentTime%2CinboxType%2CmessageState%2Ccreated%28time%2Cactor~%28entityUrn%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%29%29%2CreviewNotes*%2CopenReviewRequests*%28entityUrn%2Cowner%2Cjob%2CcapProject%2ChiringProject%2Ccandidates%2Creviewers*~%28entityUrn%2Cstate%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%2CseatEntitlements%2CseatRoles%2Ccontract%2Cdescription%2CpenaltyBoxInfo%2CentitlementsWithMetadata*%2CproductRestrictions*%29%2ChiringContext%2Cid%2Ccreated%2ClastModified%2Cdeleted%29%2CsourcingChannelCandidates*%28applyStarterInfo%2Ccandidate%2Ccreated%2CentityUrn%2ChiringContext%2ClastModified%2CsourcingChannel%2CjobApplicationInfo%28contactEmail%2CcontactPhoneNumber%2Cfeatured%2CjobApplication~%2Csource%29%2CjobPostingRelevanceReasons*%29%2CsourcingChannel%2Cnotes*%28candidate%2CchildNotes*%28candidate%2CchildNotes*%2Ccontent%2Ccreated%2CentityUrn%2ChiringContext%2ClastModified%2Cowner~%28entityUrn%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%2Cproject%2CmessageModified%2Cmessage%2CparentNote%2Cvisibility%2CsourceType%29%2Ccontent%2Ccreated%2CentityUrn%2ChiringContext%2ClastModified%2Cowner~%28entityUrn%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%2Cproject%2CmessageModified%2Cmessage%2CparentNote%2Cvisibility%2CsourceType%29%2CresumeHiringDocumentsV2s*%2CcompanyRelevanceReasons*%2CcontactInfo%2CmessageUrl%2CcandidateFeedbacks*%28entityUrn%2Ccontract%2Ccompany%2ChiringProject~%28entityUrn%2ChiringProjectMetadata%28name%29%29%2CjobTitle%2CjobPosting~%28title%29%2Crequester%2CrequesterRole%2Crequestee~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%2Ccandidate%2Cfeedback%28relationship%2Cnote%2CreasonsToNotRecommendCandidate%2CskillFit%29%2Cmessage%2Cstatus%2CwouldRecommend%2Cactive%2ClastModified%2ClastRequestedTimeAt%29%2CcandidateFeedbacksV2*%28active%2CcandidateUrn%2CentityUrn%2Cfeedback%28relationship%2Cnote%2CreasonsToNotRecommendCandidate%2CskillFit%2CreviewNoteSelectedValue%2CwouldRecommend%29%2ChiringProject~%28entityUrn%2ChiringProjectMetadata%28name%29%29%2ChiringProjectUrn%2ClastModified%2Cmessage%2Crequester%2Crequestee~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%2CrequesterRole%2Cstatus%29%2CreferralUrns*~%28created%28time%29%2Cfeedback%2CjobPostingUrn~%28hiringProjectUrn~%28entityUrn%29%29%2CprimaryReferral%2CreferrerUrn~%28firstName%2Cheadline%2ClastName%2CvectorProfilePicture%2CpublicProfileUrl%29%29%2CscreenerQuestionAnswers*%2CprofileUrl%2CjobApplications%2CassessedCandidate%28candidateRejectionRecord%2CfeaturedSkills*%2Crejectable%2Cexportable%2CvideoResponses*%29%2CprofileViews*%28entityUrn%2Cseat%29%2CatsDataProviders*~%2CinMailCost%2CcontractsWithActivities%2CcandidateInsights%28candidateRecommendedMatchesInsightsUrn~%28positionsInsight%2CentityUrn%29%29%2CtcrmHireIdentitiesUrns*~%28entityUrn%2CdataProviderUrn~%28entityUrn%2Cname%2ConboardedExternalSystemTypes%29%29%2C~hiringProjectCandidatesCount%28paging%29%2C~jobApplicationsCount%28paging%29%2C~hireThirdPartyAssessmentCount%28paging%29%29%2CskillsMatchInsightUrn%29&" \
             f"count={25}&" \
             "q=pipelineSearch&" \
             f"query=(facetSelections:List((type:SOURCING_CHANNEL,valuesWithSelections:List()),(type:CANDIDATE_HIRING_STATE,valuesWithSelections:List((value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430375624%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430374734%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430376619%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430377596%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430373866%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430376618%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430374733%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430372048%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430371113%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430374732%29,selected:true,negated:false,required:false)))),capSearchSortBy:HIRING_CANDIDATE_LAST_UPDATED_DATE,hiringProjects:List((text:Skin%20Scientist,entity:urn%3Ali%3Ats_hiring_project%3A%28urn%3Ali%3Ats_contract%3A207833291%2C{project_id}%29)))&" \
             f"requestParams=(hiringProject:urn%3Ali%3Ats_hiring_project%3A%28urn%3Ali%3Ats_contract%3A207833291%2C{project_id}%29,doFacetCounting:true,doFacetDecoration:true)&" \
             f"start={index*25}"
        # data="decoration=%28entityUrn%2ClinkedInMemberProfileUrn~%28entityUrn%2Canonymized%2CreferenceUrn%2CmemberPreferences%28companySizeRange%28minSize%2CmaxSize%29%2CemploymentTypes%2CinterestedCandidateIntroductionStatement%2Clocations%2CjobSeekingUrgencyLevel%2CgeoLocations*~%28standardGeoStyleName%29%2CopenToNewOpportunities%2Ctitles%2CproxyPhoneNumberAvailability%29%2CfirstName%2ClastName%2Cheadline%2Clocation%28displayName%29%2CprofilePicture%2CvectorProfilePicture%2CnumConnections%2Chighlights%2CnetworkDistance%2Cskills*%28skillAssessmentVerified%2CskillAssessmentVerifiedAt%2CskillName%2Cskill%29%2CcanSendInMail%2Cunlinked%2Ceducations*%28school~%28entityUrn%2Cname%29%2CorganizationUrn~%28entityUrn%2Cname%29%2CschoolName%2CdegreeName%2CstartDateOn%2CendDateOn%29%2CworkExperience*%28company~%28entityUrn%2Cname%29%2CcompanyName%2Ctitle%2CstartDateOn%2CendDateOn%29%2CprivacySettings%28allowConnectionsBrowse%2CshowPremiumSubscriberIcon%29%2CviewerCompanyFollowing%28followingViewerCompany%2CstartedAt%29%2CcontactInfo%2CindustryName%2CpublicProfileUrl%29%2ChiringProjectRecruitingProfile~%28entityUrn%2Ctags*%2ChiringContext%2Ccandidate%2ChiddenCandidate%2CcurrentHiringProjectCandidate%28entityUrn%2Ccreated%28time%29%2CaddedToPipeline%28time%2Cactor~%28profile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%29%2ClastModified%2ChiringProject~%28entityUrn%2ChiringProjectMetadata%28hiringPipelineEnabled%2Cstate%29%29%2CcandidateHiringState%2CsourcingChannel~%28entityUrn%2CchannelType%29%2CsourcingChannelType%29%2CstartFollowingCompanyAt%2ClastActivity~%28activityType%2Cperformed%28time%2Cactor~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%2CperformedByViewer%2ChiringActivityData%29%2CcandidateMessageThreads*%28candidate%2CentityUrn%2ClastInboxSentTime%2CinboxType%2CmessageState%2Ccreated%28time%2Cactor~%28entityUrn%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%29%29%2CreviewNotes*%2CopenReviewRequests*%28entityUrn%2Cowner%2Cjob%2CcapProject%2ChiringProject%2Ccandidates%2Creviewers*~%28entityUrn%2Cstate%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%2CseatEntitlements%2CseatRoles%2Ccontract%2Cdescription%2CpenaltyBoxInfo%2CentitlementsWithMetadata*%2CproductRestrictions*%29%2ChiringContext%2Cid%2Ccreated%2ClastModified%2Cdeleted%29%2CsourcingChannelCandidates*%28applyStarterInfo%2Ccandidate%2Ccreated%2CentityUrn%2ChiringContext%2ClastModified%2CsourcingChannel%2CjobApplicationInfo%28contactEmail%2CcontactPhoneNumber%2Cfeatured%2CjobApplication~%2Csource%29%2CjobPostingRelevanceReasons*%29%2CsourcingChannel%2Cnotes*%28candidate%2CchildNotes*%28candidate%2CchildNotes*%2Ccontent%2Ccreated%2CentityUrn%2ChiringContext%2ClastModified%2Cowner~%28entityUrn%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%2Cproject%2CmessageModified%2Cmessage%2CparentNote%2Cvisibility%2CsourceType%29%2Ccontent%2Ccreated%2CentityUrn%2ChiringContext%2ClastModified%2Cowner~%28entityUrn%2Cprofile~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%29%2Cproject%2CmessageModified%2Cmessage%2CparentNote%2Cvisibility%2CsourceType%29%2CresumeHiringDocumentsV2s*%2CcompanyRelevanceReasons*%2CcontactInfo%2CmessageUrl%2CcandidateFeedbacks*%28entityUrn%2Ccontract%2Ccompany%2ChiringProject~%28entityUrn%2ChiringProjectMetadata%28name%29%29%2CjobTitle%2CjobPosting~%28title%29%2Crequester%2CrequesterRole%2Crequestee~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%2Ccandidate%2Cfeedback%28relationship%2Cnote%2CreasonsToNotRecommendCandidate%2CskillFit%29%2Cmessage%2Cstatus%2CwouldRecommend%2Cactive%2ClastModified%2ClastRequestedTimeAt%29%2CcandidateFeedbacksV2*%28active%2CcandidateUrn%2CentityUrn%2Cfeedback%28relationship%2Cnote%2CreasonsToNotRecommendCandidate%2CskillFit%2CreviewNoteSelectedValue%2CwouldRecommend%29%2ChiringProject~%28entityUrn%2ChiringProjectMetadata%28name%29%29%2ChiringProjectUrn%2ClastModified%2Cmessage%2Crequester%2Crequestee~%28entityUrn%2CfirstName%2ClastName%2Cheadline%2CprofilePicture%2CvectorProfilePicture%2CpublicProfileUrl%2CfollowerCount%2CnetworkDistance%2CautomatedActionProfile%29%2CrequesterRole%2Cstatus%29%2CreferralUrns*~%28created%28time%29%2Cfeedback%2CjobPostingUrn~%28hiringProjectUrn~%28entityUrn%29%29%2CprimaryReferral%2CreferrerUrn~%28firstName%2Cheadline%2ClastName%2CvectorProfilePicture%2CpublicProfileUrl%29%29%2CscreenerQuestionAnswers*%2CprofileUrl%2CjobApplications%2CassessedCandidate%28candidateRejectionRecord%2CfeaturedSkills*%2Crejectable%2Cexportable%2CvideoResponses*%29%2CprofileViews*%28entityUrn%2Cseat%29%2CatsDataProviders*~%2CinMailCost%2CcontractsWithActivities%2CcandidateInsights%28candidateRecommendedMatchesInsightsUrn~%28positionsInsight%2CentityUrn%29%29%2CtcrmHireIdentitiesUrns*~%28entityUrn%2CdataProviderUrn~%28entityUrn%2Cname%2ConboardedExternalSystemTypes%29%29%2C~hiringProjectCandidatesCount%28paging%29%2C~jobApplicationsCount%28paging%29%2C~hireThirdPartyAssessmentCount%28paging%29%29%2CskillsMatchInsightUrn%29&count=25&q=pipelineSearch&query=(facetSelections:List((type:SOURCING_CHANNEL,valuesWithSelections:List()),(type:CANDIDATE_HIRING_STATE,valuesWithSelections:List((value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430375624%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430374734%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430376619%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430377596%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430373866%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430376618%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430374733%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430372048%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430371113%29,selected:true,negated:false,required:false),(value:urn%3Ali%3Ats_hiring_state%3A%28urn%3Ali%3Ats_contract%3A207833291%2C10430374732%29,selected:true,negated:false,required:false)))),capSearchSortBy:HIRING_CANDIDATE_LAST_UPDATED_DATE,hiringProjects:List((text:Johnson%20Migrated%20Clipboard,entity:urn%3Ali%3Ats_hiring_project%3A%28urn%3Ali%3Ats_contract%3A207833291%2C376124770%29)))&requestParams=(hiringProject:urn%3Ali%3Ats_hiring_project%3A%28urn%3Ali%3Ats_contract%3A207833291%2C376124770%29,doFacetCounting:true,doFacetDecoration:true)&start=25"
        data_list = data.split("&")
        _data = {}

        for _ in data_list:
            __ = _.split("=")
            _data[__[0]] = __[1]




        response = requests.request("POST", url, headers=headers, data=data)
        try:
            result["meta"] = response.json()["metadata"]
        except Exception as e:
            logger.info(response.text)
            logger.info(response.status_code)
            quit()
        if response.status_code == 200:
            elements_list: list = response.json()["elements"]
            logger.info(f"project->{project_id} index->{index} size->{len(elements_list)}")
            for elements in elements_list:
                candidate_list.append(elements)
                #logger.info(elements["linkedInMemberProfileUrnResolutionResult"].get("lastName", "")+elements["linkedInMemberProfileUrnResolutionResult"].get("firstName", ""))
            if len(elements_list) < 25:
                break
        else:
            logger.error(f"{response.status_code} === {response.text}")
            quit()
        index = index + 1

    result["candidate_list"] = candidate_list
    with open("/Users/chenjiabin/Project/data-sync-cdc/channel/linkedin/project_id/project_map_candidate.jsonl", "a") as f:
        f.write(json.dumps(result, ensure_ascii=False) + "\n")
    logger.info(f"project_id->{project_id}")
    return result
if __name__ == '__main__':
    project = get_candidate_info_list("376124770")
